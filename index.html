<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>VSA CHEAT - N·ªÅn t·∫£ng gi·∫£i ph√°p game s·ªë 1</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.2);
            border-radius: 20px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: white;
            border-right: 1px solid rgba(203, 213, 225, 0.2);
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 50;
            overflow-y: auto;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.02);
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
                width: 240px;
            }
            
            .main-content {
                margin-left: 240px;
            }
            
            .sidebar-backdrop {
                display: none;
            }
        }

        /* Nav Item Styles */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            margin: 4px 8px;
            border-radius: 14px;
            color: #64748b;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #f8fafc;
            color: #4f46e5;
        }

        .nav-item.active {
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 22px;
        }

        /* Product Card */
        .product-card {
            background: white;
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(203, 213, 225, 0.2);
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 30px -10px rgba(79, 70, 229, 0.15);
            border-color: #4f46e5;
        }

        .product-image {
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(4px);
            border-radius: 20px;
            font-size: 0.65rem;
            font-weight: 600;
            color: #10b981;
        }

        /* Check Icon Style */
        .check-icon {
            background: #4f46e5;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0;
            margin-right: 6px;
        }

        /* Description List */
        .desc-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 6px;
            font-size: 0.8rem;
            color: #334155;
            line-height: 1.4;
        }

        .product-description-preview {
            background: #f8fafc;
            border-radius: 12px;
            padding: 8px;
            margin: 8px 0;
        }

        /* Ranking Item */
        .ranking-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px;
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .ranking-item:hover {
            background: #f8fafc;
        }

        .ranking-item .w-10.h-10 {
            width: 32px;
            height: 32px;
            font-size: 0.9rem;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 16px;
            width: 92%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Package Card */
        .package-item {
            border: 1.5px solid #e2e8f0;
            border-radius: 16px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .package-item:hover {
            border-color: #4f46e5;
            background: #f8fafc;
        }

        .package-item.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .package-item .text-lg {
            font-size: 1rem;
        }

        /* Buy Button */
        .buy-btn {
            width: 100%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 10px;
            border-radius: 14px;
            font-weight: 600;
            font-size: 0.85rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px #4f46e5;
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 30;
        }

        .chat-button {
            width: 50px;
            height: 50px;
            border-radius: 30px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px rgba(79, 70, 229, 0.4);
            transition: all 0.3s ease;
        }

        .chat-button:hover {
            transform: scale(1.1);
        }

        .chat-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 320px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            display: none;
        }

        .chat-window.active {
            display: block;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            padding: 10px 20px;
            border-radius: 100px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            font-size: 0.85rem;
            color: #1e293b;
            z-index: 1000;
            transition: transform 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile adjustments - TƒÇNG K√çCH C·ª† S·∫¢N PH·∫®M */
        @media (max-width: 640px) {
            .p-4 {
                padding: 12px;
            }
            
            .lg\:p-8 {
                padding: 12px;
            }
            
            h2.text-2xl {
                font-size: 1.25rem;
            }
            
            .text-lg {
                font-size: 0.95rem;
            }
            
            .h-64 {
                height: 180px;
            }
            
            .p-8 {
                padding: 14px;
            }
            
            .text-3xl {
                font-size: 1.4rem;
            }
            
            .text-sm {
                font-size: 0.7rem;
            }

            /* TƒÇNG K√çCH C·ª† S·∫¢N PH·∫®M TR√äN MOBILE */
            .grid-cols-2 {
                grid-template-columns: repeat(1, minmax(0, 1fr)) !important;
                gap: 16px !important;
            }
            
            .product-card {
                margin-bottom: 8px;
            }
            
            .product-image {
                aspect-ratio: 21/9;
            }
            
            .product-description-preview .desc-item {
                font-size: 0.9rem;
                margin-bottom: 8px;
            }
            
            .buy-btn {
                padding: 14px;
                font-size: 1rem;
            }
            
            .text-base.font-bold {
                font-size: 1.1rem;
            }
            
            .product-badge {
                font-size: 0.75rem;
                padding: 4px 10px;
            }
        }

        /* Login required message */
        .login-required-message {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }

        .login-required-message i {
            font-size: 48px;
            color: #94a3b8;
            margin-bottom: 16px;
        }

        .login-required-message h3 {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .login-required-message p {
            font-size: 14px;
            color: #64748b;
            margin-bottom: 20px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 12px 24px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px #4f46e5;
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Sidebar Backdrop -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-5">
            <!-- Brand -->
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                    V
                </div>
                <div>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        VSA CHEAT
                    </h1>
                    <p class="text-[0.65rem] text-gray-400">Gi·∫£i ph√°p game s·ªë 1</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="space-y-1 mb-6">
                <div class="nav-item active" onclick="switchPage('home')">
                    <i class="fa-solid fa-house"></i>
                    <span>Trang ch·ªß</span>
                </div>
                <div class="nav-item" onclick="switchPage('products')">
                    <i class="fa-solid fa-cubes"></i>
                    <span>S·∫£n ph·∫©m</span>
                </div>
                <div class="nav-item" onclick="switchPage('keys')">
                    <i class="fa-solid fa-key"></i>
                    <span>Key c·ªßa t√¥i</span>
                </div>
                <div class="nav-item" onclick="switchPage('history')">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>L·ªãch s·ª≠</span>
                </div>
                <div class="nav-item" onclick="switchPage('ranking')">
                    <i class="fa-solid fa-trophy"></i>
                    <span>X·∫øp h·∫°ng</span>
                </div>
            </div>

            <!-- User Card -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-3">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 text-xl">
                        <i class="fa-regular fa-user" id="userIcon"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 text-sm" id="sidebarUserName">Kh√°ch</p>
                        <p class="text-[0.6rem] text-gray-500" id="sidebarUserStatus">Ch∆∞a ƒëƒÉng nh·∫≠p</p>
                    </div>
                </div>
                
                <div class="border-t border-white/50 pt-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-600">S·ªë d∆∞</span>
                        <span class="font-bold text-indigo-600 text-sm" id="sidebarBalance">0‚Ç´</span>
                    </div>
                    
                    <div id="sidebarAuth">
                        <button onclick="window.location.href='account.html'" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl font-semibold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-right-to-bracket text-xs"></i>
                            ƒêƒÉng nh·∫≠p
                        </button>
                    </div>
                    
                    <div id="sidebarUser" style="display: none;">
                        <button onclick="logout()" class="w-full bg-red-500 text-white py-2 px-3 rounded-xl font-semibold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-right-from-bracket text-xs"></i>
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content min-h-screen">
        <!-- Mobile Header -->
        <header class="lg:hidden bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-30">
            <div class="flex items-center justify-between px-3 py-2">
                <div class="flex items-center gap-2">
                    <button onclick="toggleSidebar()" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                        <i class="fa-solid fa-bars text-sm"></i>
                    </button>
                    <div>
                        <span class="font-bold text-indigo-600 text-sm">VSA</span>
                        <span class="font-bold text-gray-900 text-sm">CHEAT</span>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="showTopupModal()" id="mobileTopupBtn" style="display: none;" class="w-8 h-8 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600">
                        <i class="fa-solid fa-wallet text-sm"></i>
                    </button>
                    <button onclick="window.location.href='account.html'" id="mobileLoginBtn" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                        <i class="fa-solid fa-user text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="px-3 pb-2">
                <h2 class="text-base font-bold text-gray-900" id="currentPageTitle">Trang ch·ªß</h2>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-4 lg:p-6" id="contentArea">
            <!-- Content will be loaded here -->
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <div class="chat-window" id="chatWindow">
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 p-3 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <i class="fa-solid fa-headset text-xl"></i>
                        <div>
                            <h3 class="font-semibold text-sm">H·ªó tr·ª£ tr·ª±c tuy·∫øn</h3>
                            <p class="text-[0.6rem] text-indigo-100">Nh√¢n vi√™n s·∫Ω ph·∫£n h·ªìi s·ªõm</p>
                        </div>
                    </div>
                    <button onclick="toggleChat()" class="w-6 h-6 bg-white/20 rounded-full flex items-center justify-center">
                        <i class="fa-solid fa-times text-xs"></i>
                    </button>
                </div>
            </div>
            
            <div class="h-64 overflow-y-auto p-3 bg-gray-50" id="chatMessages">
                <div class="text-center text-gray-400 py-6">
                    <i class="fa-regular fa-message text-3xl mb-2"></i>
                    <p class="text-xs">B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán...</p>
                </div>
            </div>
            
            <form onsubmit="sendMessage(event)" class="p-3 bg-white border-t border-gray-100">
                <div class="flex gap-2">
                    <input type="text" class="flex-1 px-3 py-1.5 border border-gray-200 rounded-full text-xs focus:outline-none focus:border-indigo-500" placeholder="Nh·∫≠p tin nh·∫Øn..." required>
                    <button type="submit" class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center hover:bg-indigo-700">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </div>
            </form>
        </div>
        
        <button onclick="toggleChat()" class="chat-button">
            <i class="fa-regular fa-message text-lg"></i>
        </button>
    </div>

    <!-- Topup Modal -->
    <div class="modal" id="topupModal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">N·∫°p ti·ªÅn</h2>
                <button onclick="closeModal('topupModal')" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">S·ªë ti·ªÅn</label>
                    <div class="relative">
                        <i class="fa-solid fa-coins absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                        <input type="number" id="topupAmount" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500" placeholder="Nh·∫≠p s·ªë ti·ªÅn" min="10000" step="10000">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Ph∆∞∆°ng th·ª©c</label>
                    <select id="topupMethod" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                        <option value="Momo">Momo</option>
                        <option value="Banking">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                        <option value="Card">Th·∫ª c√†o</option>
                    </select>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="processTopup()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl font-semibold text-sm hover:shadow-lg transition-all">
                        X√°c nh·∫≠n
                    </button>
                    <button onclick="closeModal('topupModal')" class="px-4 py-2 border border-gray-200 rounded-xl text-sm font-semibold hover:bg-gray-50">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">Thanh to√°n</h2>
                <button onclick="closeModal('paymentModal')" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div id="paymentContent"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyE1_70ua0L2mj9jtfOA6LxiEbshiiKvQ_8_r62jT1al_yFg50gDAINyt1CwDNkwOw0jQ/exec';
        
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let allProducts = [];
        let allRankings = [];
        let currentPage = 'home';
        let autoRefreshInterval = null;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            loadHomePage();
            setupSidebar();
            startAutoRefresh();
        });

        // ==================== AUTO REFRESH ====================
        function startAutoRefresh() {
            // Auto refresh every 3 seconds
            autoRefreshInterval = setInterval(() => {
                if (currentPage === 'home') {
                    loadHomePage(true); // silent refresh
                } else if (currentPage === 'products') {
                    loadProductsPage(true);
                } else if (currentPage === 'ranking') {
                    loadRankingPage(true);
                }
            }, 3000);
        }

        // ==================== SIDEBAR FUNCTIONS ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarBackdrop').classList.toggle('active');
        }
        
        function setupSidebar() {
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            sidebarBackdrop.addEventListener('click', toggleSidebar);
            
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    document.getElementById('sidebar').classList.add('active');
                    document.getElementById('sidebarBackdrop').classList.remove('active');
                } else {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarBackdrop').classList.remove('active');
                }
            });
            
            if (window.innerWidth >= 1024) {
                document.getElementById('sidebar').classList.add('active');
            }
        }

        // ==================== PAGE SWITCHING ====================
        function switchPage(page) {
            currentPage = page;
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
            
            const titles = {
                'home': 'Trang ch·ªß',
                'products': 'S·∫£n ph·∫©m',
                'keys': 'Key c·ªßa t√¥i',
                'history': 'L·ªãch s·ª≠',
                'ranking': 'X·∫øp h·∫°ng'
            };
            document.getElementById('currentPageTitle').textContent = titles[page];
            
            switch(page) {
                case 'home':
                    loadHomePage();
                    break;
                case 'products':
                    loadProductsPage();
                    break;
                case 'keys':
                    loadKeysPage();
                    break;
                case 'history':
                    loadHistoryPage();
                    break;
                case 'ranking':
                    loadRankingPage();
                    break;
            }
            
            if (window.innerWidth < 1024) {
                toggleSidebar();
            }
        }

        // ==================== CHECK LOGIN STATUS ====================
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateUIForLoggedInUser();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        }
        
        function updateUIForLoggedInUser() {
            if (currentUser) {
                document.getElementById('sidebarUserName').textContent = currentUser.fullName || currentUser.username;
                document.getElementById('sidebarUserStatus').textContent = currentUser.type || 'Th∆∞·ªùng';
                document.getElementById('sidebarBalance').textContent = formatMoney(currentUser.balance || 0);
                
                if (currentUser.type === 'Th√¢n thi·∫øt') {
                    document.getElementById('userIcon').className = 'fa-solid fa-star text-amber-500';
                } else {
                    document.getElementById('userIcon').className = 'fa-regular fa-user';
                }
                
                document.getElementById('sidebarAuth').style.display = 'none';
                document.getElementById('sidebarUser').style.display = 'block';
                
                document.getElementById('mobileLoginBtn').style.display = 'none';
                document.getElementById('mobileTopupBtn').style.display = 'flex';
                
                refreshUserData();
            }
        }
        
        async function refreshUserData() {
            if (!currentUser) return;
            
            const formData = new FormData();
            formData.append('action', 'getUserInfo');
            formData.append('userId', currentUser.id);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    currentUser = { ...currentUser, ...data.user };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('sidebarBalance').textContent = formatMoney(currentUser.balance || 0);
                    
                    if (currentUser.type === 'Th√¢n thi·∫øt') {
                        document.getElementById('sidebarUserStatus').textContent = 'Th√¢n thi·∫øt';
                        document.getElementById('userIcon').className = 'fa-solid fa-star text-amber-500';
                    }
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }
        
        // ==================== API CALLS ====================
        async function fetchProducts() {
            const formData = new FormData();
            formData.append('action', 'getProducts');
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    allProducts = data.products || [];
                    return allProducts;
                }
                return [];
            } catch (error) {
                console.error('Error fetching products:', error);
                return [];
            }
        }
        
        async function fetchRankings() {
            const formData = new FormData();
            formData.append('action', 'getRankings');
            formData.append('month', new Date().getMonth() + 1);
            formData.append('year', new Date().getFullYear());
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    allRankings = data.rankings || [];
                    return allRankings;
                }
                return [];
            } catch (error) {
                console.error('Error fetching rankings:', error);
                return [];
            }
        }
        
        // ==================== PARSE DESCRIPTION ====================
        function parseDescription(description) {
            if (!description) return [];
            return description.split('\n').filter(line => line.trim() !== '');
        }
        
        function renderDescriptionItems(descriptionLines, limit = null) {
            const lines = limit ? descriptionLines.slice(0, limit) : descriptionLines;
            
            return lines.map(line => `
                <div class="desc-item">
                    <span class="check-icon">
                        <i class="fa-solid fa-check"></i>
                    </span>
                    <span>${line}</span>
                </div>
            `).join('');
        }
        
        // ==================== CREATE SLUG ====================
        function createSlug(name) {
            if (!name) return '';
            return name.toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/ƒë/g, 'd')
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/^-|-$/g, '');
        }
        
        function viewProductDetail(productName) {
            const slug = createSlug(productName);
            localStorage.setItem('viewProduct', productName);
            window.location.href = 'detail.html';
        }

        function viewProductDetailExternal(url) {
            window.location.href = url;
        }
        
        // ==================== HOME PAGE ====================
        async function loadHomePage(silent = false) {
            const content = document.getElementById('contentArea');
            
            if (!silent) {
                content.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 mb-6">
                        <div class="lg:col-span-8 skeleton h-48 lg:h-80 rounded-2xl"></div>
                        <div class="lg:col-span-4 skeleton h-48 lg:h-80 rounded-2xl"></div>
                    </div>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        ${Array(4).fill('<div class="skeleton h-56 rounded-xl"></div>').join('')}
                    </div>
                `;
            }
            
            const [products, rankings] = await Promise.all([
                fetchProducts(),
                fetchRankings()
            ]);
            
            // T·∫°o s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh "Ch·ª©ng Ch·ªâ iPhone/iPad" v·ªõi gi√° "Gi√° r·∫ª b·∫•t ng·ªù"
            const defaultProduct = {
                id: 'default_cert',
                name: 'Ch·ª©ng Ch·ªâ iPhone/iPad',
                category: 'Ch·ª©ng ch·ªâ',
                description: 'H·ªó tr·ª£ iPhone/iPad\nH·ªó tr·ª£ ESign, Gbox, Scarlet, ...\nK√≠ch ho·∫°t vƒ©nh vi·ªÖn\nB·∫£o h√†nh tr·ªçn ƒë·ªùi\nH·ªó tr·ª£ 24/7',
                cover: 'https://vsacheat.com/img/logocert.jpg',
                prices: {
                    day: 150000,
                    week: 350000,
                    month: 650000,
                    season: 1500000,
                    year: 2500000
                },
                stock: 9999,
                sold: 8386,
                position: 1,
                external_link: 'https://chungchip12.com'
            };
            
            // K·∫øt h·ª£p s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh v·ªõi s·∫£n ph·∫©m t·ª´ API
            let allProductsWithDefault = [defaultProduct, ...products];
            
            // ƒê√ÅNH S·ªê TH·ª® T·ª∞: s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh lu√¥n ·ªü v·ªã tr√≠ 1 d√π c√≥ th√™m s·∫£n ph·∫©m m·ªõi
            // C√°c s·∫£n ph·∫©m kh√°c s·∫Ω ƒë∆∞·ª£c ƒë√°nh s·ªë t·ª´ 2 tr·ªü ƒëi
            const sortedProducts = allProductsWithDefault.map((product, index) => {
                if (product.name === 'Ch·ª©ng Ch·ªâ iPhone/iPad') {
                    product.position = 1;
                } else {
                    product.position = index + 1; // index b·∫Øt ƒë·∫ßu t·ª´ 1 v√¨ ƒë√£ c√≥ s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh ·ªü v·ªã tr√≠ 0
                }
                return product;
            }).sort((a, b) => a.position - b.position);
            
            // X·ª≠ l√Ω che t√™n cho ranking
            const rankingsHTML = rankings.slice(0, 5).map((rank, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[index] || `${index + 1}`;
                const bgColors = ['bg-amber-100', 'bg-gray-100', 'bg-orange-100', 'bg-indigo-50'];
                const bgColor = bgColors[index] || 'bg-gray-50';
                
                // Che t√™n: gi·ªØ l·∫°i k√Ω t·ª± ƒë·∫ßu v√† cu·ªëi, thay th·∫ø gi·ªØa b·∫±ng **
                let displayName = rank.fullName || rank.userId || 'Kh√°ch';
                if (displayName.length > 2) {
                    displayName = displayName.charAt(0) + '**' + displayName.charAt(displayName.length - 1);
                } else if (displayName.length > 1) {
                    displayName = displayName.charAt(0) + '**';
                }
                
                return `
                    <div class="ranking-item">
                        <div class="w-8 h-8 rounded-xl ${bgColor} flex items-center justify-center font-bold text-sm">
                            ${medal}
                        </div>
                        <div class="flex-1">
                            <p class="font-semibold text-gray-900 text-sm">${displayName}</p>
                            <p class="text-[0.6rem] text-gray-400">${formatMoney(rank.totalSpent || 0)}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            // L·∫•y 3 s·∫£n ph·∫©m n·ªïi b·∫≠t (kh√¥ng t√≠nh s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh)
            const featuredProducts = sortedProducts.filter(p => p.name !== 'Ch·ª©ng Ch·ªâ iPhone/iPad').slice(0, 3);
            
            const productsHTML = featuredProducts.map(product => {
                const descriptionLines = parseDescription(product.description);
                const imageUrl = product.cover || '';
                
                return `
                    <div class="product-card">
                        <div class="product-image">
                            ${imageUrl ? 
                                `<img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect width=\'300\' height=\'200\' fill=\'%234f46e5\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-family=\'Arial\'%3E${product.name}%3C/text%3E%3C/svg%3E';">` :
                                `<div class="w-full h-full flex items-center justify-center text-white text-3xl">
                                    <i class="fa-solid fa-gamepad"></i>
                                </div>`
                            }
                            <div class="product-badge">
                                <i class="fa-regular fa-clock mr-1"></i>
                                ${product.stock > 0 ? `C√≤n ${product.stock}` : 'H·∫øt h√†ng'}
                            </div>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-gray-900 text-sm mb-1">${product.name || 'S·∫£n ph·∫©m'}</h3>
                            
                            <div class="product-description-preview">
                                ${renderDescriptionItems(descriptionLines, 2)}
                                ${descriptionLines.length > 2 ? 
                                    `<p class="text-[0.6rem] text-indigo-600 mt-1">+${descriptionLines.length - 2} t√≠nh nƒÉng kh√°c</p>` : 
                                    ''}
                            </div>
                            
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-base font-bold text-indigo-600">${formatMoney(product.prices?.day || 0)}</span>
                                <span class="text-[0.6rem] text-gray-400">ƒê√£ b√°n ${product.sold || 0}</span>
                            </div>
                            
                            <button onclick="viewProductDetail('${product.name.replace(/'/g, "\\'")}')" class="buy-btn text-xs">
                                <i class="fa-solid fa-cart-shopping"></i>
                                Mua ngay
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // S·∫£n ph·∫©m m·∫∑c ƒë·ªãnh ri√™ng v·ªõi gi√° "Gi√° r·∫ª b·∫•t ng·ªù"
            const defaultProductHTML = `
                <div class="product-card">
                    <div class="product-image">
                        <img src="https://vsacheat.com/img/logocert.jpg" alt="Ch·ª©ng Ch·ªâ iPhone/iPad" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect width=\'300\' height=\'200\' fill=\'%234f46e5\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-family=\'Arial\'%3ECh·ª©ng Ch·ªâ iPhone/iPad%3C/text%3E%3C/svg%3E';">
                        <div class="product-badge">
                            <i class="fa-regular fa-clock mr-1"></i>
                            C√≤n 9999
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-gray-900 text-sm mb-1">Ch·ª©ng Ch·ªâ iPhone/iPad</h3>
                        
                        <div class="product-description-preview">
                            <div class="desc-item">
                                <span class="check-icon">
                                    <i class="fa-solid fa-check"></i>
                                </span>
                                <span>H·ªó tr·ª£ iPhone/iPad</span>
                            </div>
                            <div class="desc-item">
                                <span class="check-icon">
                                    <i class="fa-solid fa-check"></i>
                                </span>
                                <span>H·ªó tr·ª£ ESign, Gbox, Scarlet, ...</span>
                            </div>
                            <p class="text-[0.6rem] text-indigo-600 mt-1">+3 t√≠nh nƒÉng kh√°c</p>
                        </div>
                        
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-base font-bold text-green-600">Gi√° r·∫ª b·∫•t ng·ªù</span>
                            <span class="text-[0.6rem] text-gray-400">ƒê√£ b√°n 8386</span>
                        </div>
                        
                        <button onclick="window.location.href='https://chungchip12.com'" class="buy-btn text-xs">
                            <i class="fa-solid fa-cart-shopping"></i>
                            Mua ngay
                        </button>
                    </div>
                </div>
            `;
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Hero & Ranking -->
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
                        <!-- Hero -->
                        <div class="lg:col-span-8 relative rounded-2xl overflow-hidden bg-gradient-to-br from-indigo-600 to-purple-600 h-48 lg:h-72 group">
                            <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMzAgMzBoMzB2MzBIMzB6TTAgMGgzMHYzMEgweiIgZmlsbD0icmdiYSgyNTUsMjU1LDI1NSwwLjA1KSIgZmlsbC1ydWxlPSJldmVub2RkIi8+PC9zdmc+')] opacity-20"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent"></div>
                            <div class="absolute bottom-0 left-0 p-4">
                                <span class="inline-flex items-center gap-1 px-2 py-0.5 bg-white/20 backdrop-blur-md rounded-full text-white text-[0.6rem] mb-2">
                                    <span class="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span>
                                    GI·∫¢I PH√ÅP S·ªê 1
                                </span>
                                <h2 class="text-2xl lg:text-3xl font-bold text-white mb-1">VSA CHEAT</h2>
                                <p class="text-white/80 text-xs lg:text-sm mb-3 max-w-lg">H·ªá th·ªëng ph√¢n ph·ªëi gi·∫£i ph√°p game t·ª± ƒë·ªông 24/7</p>
                                <button onclick="switchPage('products')" class="bg-white text-indigo-600 px-4 py-2 rounded-xl font-semibold text-xs hover:shadow-xl transition-all flex items-center gap-1">
                                    Kh√°m ph√° ngay
                                    <i class="fa-solid fa-arrow-right text-xs"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Ranking -->
                        <div class="lg:col-span-4 bg-white rounded-2xl border border-gray-100 overflow-hidden">
                            <div class="p-3 border-b border-gray-100">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center gap-1">
                                        <div class="w-6 h-6 bg-amber-100 rounded-lg flex items-center justify-center text-amber-600 text-xs">
                                            <i class="fa-solid fa-trophy"></i>
                                        </div>
                                        <h3 class="font-bold text-sm">BXH Th√°ng ${new Date().getMonth() + 1}</h3>
                                    </div>
                                    <button onclick="switchPage('ranking')" class="text-[0.6rem] text-indigo-600 hover:text-indigo-700">Xem th√™m</button>
                                </div>
                            </div>
                            <div class="p-3 space-y-1 max-h-56 overflow-y-auto">
                                ${rankingsHTML || '<div class="text-center text-gray-400 py-3 text-xs">Ch∆∞a c√≥ d·ªØ li·ªáu</div>'}
                            </div>
                            <div class="p-3 border-t border-gray-100">
                                <button onclick="showTopupModal()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl font-semibold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-1">
                                    <i class="fa-solid fa-wallet text-xs"></i>
                                    N·∫°p ti·ªÅn ngay
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Products -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600">
                                    <i class="fa-solid fa-cubes text-sm"></i>
                                </div>
                                <h2 class="text-base font-bold">S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
                            </div>
                            <button onclick="switchPage('products')" class="text-indigo-600 font-medium text-xs">Xem t·∫•t c·∫£</button>
                        </div>
                        
                        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                            ${defaultProductHTML}
                            ${productsHTML || '<div class="col-span-full text-center text-gray-400 py-6 text-xs">Ch∆∞a c√≥ s·∫£n ph·∫©m</div>'}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ==================== PRODUCTS PAGE ====================
        async function loadProductsPage(silent = false) {
            const content = document.getElementById('contentArea');
            
            if (!silent) {
                content.innerHTML = `
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        ${Array(8).fill('<div class="skeleton h-56 rounded-xl"></div>').join('')}
                    </div>
                `;
            }
            
            const products = await fetchProducts();
            
            // T·∫°o s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh
            const defaultProduct = {
                id: 'default_cert',
                name: 'Ch·ª©ng Ch·ªâ iPhone/iPad',
                category: 'Ch·ª©ng ch·ªâ',
                description: 'H·ªó tr·ª£ iPhone/iPad\nH·ªó tr·ª£ ESign, Gbox, Scarlet, ...\nK√≠ch ho·∫°t vƒ©nh vi·ªÖn\nB·∫£o h√†nh tr·ªçn ƒë·ªùi\nH·ªó tr·ª£ 24/7',
                cover: 'https://vsacheat.com/img/logocert.jpg',
                prices: {
                    day: 150000,
                    week: 350000,
                    month: 650000,
                    season: 1500000,
                    year: 2500000
                },
                stock: 9999,
                sold: 8386,
                position: 1,
                external_link: 'https://chungchip12.com'
            };
            
            let allProductsWithDefault = [defaultProduct, ...products];
            
            // ƒê√ÅNH S·ªê TH·ª® T·ª∞: s·∫£n ph·∫©m m·∫∑c ƒë·ªãnh lu√¥n ·ªü v·ªã tr√≠ 1
            const sortedProducts = allProductsWithDefault.map((product, index) => {
                if (product.name === 'Ch·ª©ng Ch·ªâ iPhone/iPad') {
                    product.position = 1;
                } else {
                    product.position = index + 1;
                }
                return product;
            }).sort((a, b) => a.position - b.position);
            
            const productsHTML = sortedProducts.map(product => {
                const descriptionLines = parseDescription(product.description);
                const imageUrl = product.cover || '';
                const isDefault = product.name === 'Ch·ª©ng Ch·ªâ iPhone/iPad';
                
                return `
                    <div class="product-card">
                        <div class="product-image">
                            ${imageUrl ? 
                                `<img src="${imageUrl}" alt="${product.name}" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'300\' height=\'200\' viewBox=\'0 0 300 200\'%3E%3Crect width=\'300\' height=\'200\' fill=\'%234f46e5\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'white\' font-size=\'20\' font-family=\'Arial\'%3E${product.name}%3C/text%3E%3C/svg%3E';">` :
                                `<div class="w-full h-full flex items-center justify-center text-white text-3xl">
                                    <i class="fa-solid fa-gamepad"></i>
                                </div>`
                            }
                            <div class="product-badge">
                                <i class="fa-regular fa-clock mr-1"></i>
                                ${product.stock > 0 ? `C√≤n ${product.stock}` : 'H·∫øt h√†ng'}
                            </div>
                        </div>
                        <div class="p-3">
                            <h3 class="font-bold text-gray-900 text-sm mb-1">${product.name || 'S·∫£n ph·∫©m'}</h3>
                            
                            <div class="product-description-preview">
                                ${renderDescriptionItems(descriptionLines, 2)}
                                ${descriptionLines.length > 2 ? 
                                    `<p class="text-[0.6rem] text-indigo-600 mt-1">+${descriptionLines.length - 2} t√≠nh nƒÉng kh√°c</p>` : 
                                    ''}
                            </div>
                            
                            <div class="flex items-center justify-between mb-2">
                                ${isDefault ? 
                                    `<span class="text-base font-bold text-green-600">Gi√° r·∫ª b·∫•t ng·ªù</span>` :
                                    `<span class="text-base font-bold text-indigo-600">${formatMoney(product.prices?.day || 0)}</span>`
                                }
                                <span class="text-[0.6rem] text-gray-400">ƒê√£ b√°n ${product.sold || 0}</span>
                            </div>
                            
                            ${isDefault ? 
                                `<button onclick="window.location.href='https://chungchip12.com'" class="buy-btn text-xs">
                                    <i class="fa-solid fa-cart-shopping"></i>
                                    Mua ngay
                                </button>` :
                                `<button onclick="viewProductDetail('${product.name.replace(/'/g, "\\'")}')" class="buy-btn text-xs">
                                    <i class="fa-solid fa-cart-shopping"></i>
                                    Mua ngay
                                </button>`
                            }
                        </div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div>
                    <h2 class="text-lg font-bold mb-4">T·∫•t c·∫£ s·∫£n ph·∫©m</h2>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
                        ${productsHTML || '<div class="col-span-full text-center text-gray-400 py-8 text-xs">Ch∆∞a c√≥ s·∫£n ph·∫©m</div>'}
                    </div>
                </div>
            `;
        }
        
        // ==================== KEYS PAGE ====================
        async function loadKeysPage() {
            const content = document.getElementById('contentArea');
            
            if (!currentUser) {
                content.innerHTML = `
                    <div class="login-required-message">
                        <i class="fa-solid fa-lock"></i>
                        <h3>Vui l√≤ng ƒëƒÉng nh·∫≠p</h3>
                        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem danh s√°ch key c·ªßa m√¨nh</p>
                        <button onclick="window.location.href='account.html'" class="login-btn">
                            <i class="fa-solid fa-right-to-bracket"></i>
                            ƒêƒÇNG NH·∫¨P NGAY
                        </button>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = '<div class="text-center py-6 text-sm">ƒêang t·∫£i...</div>';
            
            const formData = new FormData();
            formData.append('action', 'getKeys');
            formData.append('userId', currentUser.id);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success && data.keys && data.keys.length > 0) {
                    const keysHTML = data.keys.map(key => `
                        <div class="bg-white rounded-xl border border-gray-100 p-3">
                            <div class="flex items-start justify-between mb-2">
                                <span class="text-[0.6rem] text-gray-400">Key code</span>
                                <span class="text-[0.6rem] px-2 py-0.5 bg-green-100 text-green-600 rounded-full">
                                    ${key.keyType || 'Key'}
                                </span>
                            </div>
                            <div class="font-mono text-xs bg-gray-50 p-2 rounded-lg mb-2 select-all break-all">
                                ${key.keyCode || ''}
                            </div>
                            <div class="flex justify-between text-[0.55rem] text-gray-400">
                                <span>Mua: ${key.purchaseDate || 'N/A'}</span>
                                <span>HSD: ${key.expiryDate || 'Vƒ©nh vi·ªÖn'}</span>
                            </div>
                        </div>
                    `).join('');
                    
                    content.innerHTML = `
                        <div>
                            <h2 class="text-lg font-bold mb-4">Key c·ªßa t√¥i</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                ${keysHTML}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-10 bg-white rounded-2xl">
                            <i class="fa-solid fa-key text-4xl text-gray-300 mb-3"></i>
                            <h3 class="text-base font-semibold text-gray-700 mb-1">Ch∆∞a c√≥ key n√†o</h3>
                            <p class="text-xs text-gray-400 mb-4">B·∫°n ch∆∞a mua s·∫£n ph·∫©m n√†o</p>
                            <button onclick="switchPage('products')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-xl text-xs font-semibold">
                                Mua ngay
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        // ==================== HISTORY PAGE ====================
        async function loadHistoryPage() {
            const content = document.getElementById('contentArea');
            
            if (!currentUser) {
                content.innerHTML = `
                    <div class="login-required-message">
                        <i class="fa-solid fa-lock"></i>
                        <h3>Vui l√≤ng ƒëƒÉng nh·∫≠p</h3>
                        <p>B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ xem l·ªãch s·ª≠ giao d·ªãch</p>
                        <button onclick="window.location.href='account.html'" class="login-btn">
                            <i class="fa-solid fa-right-to-bracket"></i>
                            ƒêƒÇNG NH·∫¨P NGAY
                        </button>
                    </div>
                `;
                return;
            }
            
            content.innerHTML = '<div class="text-center py-6 text-sm">ƒêang t·∫£i...</div>';
            
            const formData = new FormData();
            formData.append('action', 'getTransactions');
            formData.append('userId', currentUser.id);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success && data.transactions && data.transactions.length > 0) {
                    const historyHTML = data.transactions.map(trans => `
                        <div class="bg-white rounded-xl border border-gray-100 p-3">
                            <div class="flex items-start justify-between mb-1">
                                <div>
                                    <span class="font-semibold text-gray-900 text-sm">${trans.type || 'Giao d·ªãch'}</span>
                                    <span class="text-[0.55rem] text-gray-400 ml-1">${trans.id || ''}</span>
                                </div>
                                <span class="font-bold text-xs ${trans.type === 'N·∫°p ti·ªÅn' ? 'text-green-600' : 'text-indigo-600'}">
                                    ${trans.type === 'N·∫°p ti·ªÅn' ? '+' : '-'}${formatMoney(trans.amount)}
                                </span>
                            </div>
                            ${trans.product ? `<p class="text-xs text-gray-600 mb-1">${trans.product}</p>` : ''}
                            <div class="flex justify-between text-[0.55rem] text-gray-400">
                                <span>${trans.method || ''}</span>
                                <span>${trans.time || ''}</span>
                            </div>
                            ${trans.keys ? `
                                <div class="mt-2 text-[0.55rem] bg-gray-50 p-1.5 rounded">Key: ${trans.keys}</div>
                            ` : ''}
                        </div>
                    `).join('');
                    
                    content.innerHTML = `
                        <div>
                            <h2 class="text-lg font-bold mb-4">L·ªãch s·ª≠ giao d·ªãch</h2>
                            <div class="space-y-2">
                                ${historyHTML}
                            </div>
                        </div>
                    `;
                } else {
                    content.innerHTML = `
                        <div class="text-center py-10 bg-white rounded-2xl">
                            <i class="fa-solid fa-clock-rotate-left text-4xl text-gray-300 mb-3"></i>
                            <h3 class="text-base font-semibold text-gray-700 mb-1">Ch∆∞a c√≥ giao d·ªãch</h3>
                            <p class="text-xs text-gray-400 mb-4">B·∫°n ch∆∞a th·ª±c hi·ªán giao d·ªãch n√†o</p>
                            <button onclick="switchPage('products')" class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-4 py-2 rounded-xl text-xs font-semibold">
                                Mua ngay
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        // ==================== RANKING PAGE ====================
        async function loadRankingPage(silent = false) {
            const content = document.getElementById('contentArea');
            
            if (!silent) {
                content.innerHTML = '<div class="text-center py-6 text-sm">ƒêang t·∫£i...</div>';
            }
            
            const rankings = await fetchRankings();
            
            const rankingsHTML = rankings.map((rank, index) => {
                const medals = ['ü•á', 'ü•à', 'ü•â'];
                const medal = medals[index] || `${index + 1}`;
                const bgColors = ['bg-amber-50', 'bg-gray-50', 'bg-orange-50', 'bg-indigo-50'];
                const bgColor = bgColors[index] || 'bg-gray-50';
                
                // Che t√™n
                let displayName = rank.fullName || rank.userId || 'Kh√°ch';
                if (displayName.length > 2) {
                    displayName = displayName.charAt(0) + '**' + displayName.charAt(displayName.length - 1);
                } else if (displayName.length > 1) {
                    displayName = displayName.charAt(0) + '**';
                }
                
                return `
                    <div class="bg-white rounded-xl border border-gray-100 p-3 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-xl ${bgColor} flex items-center justify-center text-base font-bold">
                                ${medal}
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900 text-sm">${displayName}</p>
                                <p class="text-[0.6rem] text-gray-400">T·ªïng chi: ${formatMoney(rank.totalSpent || 0)}</p>
                            </div>
                        </div>
                        <div class="text-indigo-600 font-semibold text-xs">Th√°ng ${rank.month || new Date().getMonth() + 1}</div>
                    </div>
                `;
            }).join('');
            
            content.innerHTML = `
                <div>
                    <h2 class="text-lg font-bold mb-4">B·∫£ng x·∫øp h·∫°ng th√°ng ${new Date().getMonth() + 1}</h2>
                    <div class="space-y-2">
                        ${rankingsHTML || '<div class="text-center py-8 text-gray-400 text-sm">Ch∆∞a c√≥ d·ªØ li·ªáu x·∫øp h·∫°ng</div>'}
                    </div>
                </div>
            `;
        }
        
        // ==================== TOPUP FUNCTIONS ====================
        function showTopupModal() {
            if (!currentUser) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ n·∫°p ti·ªÅn');
                window.location.href = 'account.html';
                return;
            }
            
            document.getElementById('topupModal').classList.add('active');
        }
        
        async function processTopup() {
            const amount = document.getElementById('topupAmount').value;
            const method = document.getElementById('topupMethod').value;
            
            if (!amount || amount < 10000) {
                showToast('S·ªë ti·ªÅn n·∫°p t·ªëi thi·ªÉu 10,000‚Ç´', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'topup');
            formData.append('userId', currentUser.id);
            formData.append('amount', amount);
            formData.append('method', method);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    showToast('N·∫°p ti·ªÅn th√†nh c√¥ng!', 'success');
                    refreshUserData();
                    closeModal('topupModal');
                    document.getElementById('topupAmount').value = '';
                } else {
                    showToast(data?.message || 'N·∫°p ti·ªÅn th·∫•t b·∫°i', 'error');
                }
            } catch (error) {
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatMoney(amount) {
            if (amount === undefined || amount === null) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type === 'success' ? 'success' : type === 'error' ? 'error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            window.location.reload();
        }
        
        // ==================== CHAT FUNCTIONS ====================
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.classList.toggle('active');
        }
        
        function sendMessage(event) {
            event.preventDefault();
            const input = event.target.querySelector('input');
            const message = input.value.trim();
            
            if (!message) return;
            
            const messagesContainer = document.getElementById('chatMessages');
            
            if (messagesContainer.querySelector('.text-center')) {
                messagesContainer.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'flex justify-end mb-2';
            messageDiv.innerHTML = `
                <div class="bg-indigo-600 text-white p-2 rounded-xl max-w-[80%]">
                    <p class="text-xs">${message}</p>
                    <span class="text-[0.5rem] text-indigo-200 mt-0.5 block">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                </div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            input.value = '';
            
            setTimeout(() => {
                const replyDiv = document.createElement('div');
                replyDiv.className = 'flex justify-start mb-2';
                replyDiv.innerHTML = `
                    <div class="bg-gray-100 text-gray-800 p-2 rounded-xl max-w-[80%]">
                        <p class="text-xs">C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá. Nh√¢n vi√™n h·ªó tr·ª£ s·∫Ω ph·∫£n h·ªìi s·ªõm nh·∫•t!</p>
                        <span class="text-[0.5rem] text-gray-400 mt-0.5 block">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    </div>
                `;
                messagesContainer.appendChild(replyDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 1000);
        }
    </script>
</body>
</html>