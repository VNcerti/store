<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - VSA CHEAT</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0,1&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            600: '#4f46e5',
                            700: '#4338ca',
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: rgba(156, 163, 175, 0.3); border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background-color: rgba(156, 163, 175, 0.5); }
        
        body {
            font-family: 'Inter', sans-serif;
            background: #f1f5f9;
        }
        
        .admin-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 260px;
            background: white;
            border-right: 1px solid #e2e8f0;
            padding: 2rem 1rem;
            overflow-y: auto;
        }
        
        .admin-main {
            margin-left: 260px;
            padding: 2rem;
        }
        
        .admin-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.9rem 1rem;
            border-radius: 1rem;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }
        
        .admin-menu-item:hover {
            background: #f8fafc;
            color: #4f46e5;
        }
        
        .admin-menu-item.active {
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }
        
        .admin-card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .admin-table th {
            text-align: left;
            padding: 1rem;
            background: #f8fafc;
            color: #475569;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .admin-table td {
            padding: 1rem;
            border-bottom: 1px solid #f1f5f9;
            color: #1e293b;
        }
        
        .admin-table tr:hover {
            background: #f8fafc;
        }
        
        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d1fae5;
            color: #059669;
        }
        
        .badge-warning {
            background: #fed7aa;
            color: #c2410c;
        }
        
        .badge-danger {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .badge-info {
            background: #dbeafe;
            color: #2563eb;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 1.5rem;
            padding: 2rem;
            width: 90%;
            max-width: 550px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }
        
        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid #e2e8f0;
            border-radius: 1rem;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-input::placeholder {
            color: #94a3b8;
            font-weight: 400;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: #4f46e5;
            color: white;
        }
        
        .btn-primary:hover {
            background: #4338ca;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px #4f46e5;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-outline {
            background: white;
            border: 1.5px solid #e2e8f0;
            color: #475569;
        }
        
        .btn-outline:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            background: #eef2ff;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #4f46e5;
        }
        
        .stat-info h3 {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .stat-info p {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .login-required {
            display: none;
            text-align: center;
            padding: 3rem;
            background: white;
            border-radius: 1.5rem;
            max-width: 400px;
            margin: 2rem auto;
        }
        
        .login-required.active {
            display: block;
        }
        
        .content-area {
            display: none;
        }
        
        .content-area.active {
            display: block;
        }
        
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 1rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1100;
            font-weight: 500;
            border: 1px solid #e2e8f0;
            animation: slideUp 0.3s ease;
        }
        
        .toast.show {
            display: block;
        }
        
        .toast.success {
            background: #10b981;
            color: white;
            border: none;
        }
        
        .toast.error {
            background: #ef4444;
            color: white;
            border: none;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        .price-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .key-input {
            font-family: monospace;
            min-height: 150px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1.5rem;
        }
        
        .flex-between {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Admin Login Check -->
    <div id="loginRequired" class="login-required active">
        <span class="material-symbols-outlined text-6xl text-slate-300 mb-4">admin_panel_settings</span>
        <h2 class="text-2xl font-bold text-slate-900 mb-2">Yêu cầu đăng nhập</h2>
        <p class="text-slate-500 mb-6">Vui lòng đăng nhập với tài khoản admin để tiếp tục</p>
        <a href="account.html" class="btn btn-primary">Đến trang đăng nhập</a>
    </div>
    
    <!-- Admin Content -->
    <div id="adminContent" class="content-area">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div style="margin-bottom: 2rem; padding: 0 1rem;">
                <h1 style="font-size: 1.5rem; font-weight: 800; background: linear-gradient(135deg, #4f46e5, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    VSA CHEAT
                </h1>
                <p style="color: #64748b; font-size: 0.875rem;">Admin Panel</p>
            </div>
            
            <div style="margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 1rem;">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <div style="width: 3rem; height: 3rem; background: #eef2ff; border-radius: 1rem; display: flex; align-items: center; justify-content: center;">
                        <span class="material-symbols-outlined text-brand-600">admin_panel_settings</span>
                    </div>
                    <div>
                        <p style="font-weight: 600; color: #1e293b;" id="adminName">Admin</p>
                        <p style="font-size: 0.75rem; color: #64748b;">Quản trị viên</p>
                    </div>
                </div>
            </div>
            
            <div class="admin-menu">
                <div class="admin-menu-item active" onclick="switchAdminTab('dashboard')">
                    <span class="material-symbols-outlined">dashboard</span>
                    Tổng quan
                </div>
                <div class="admin-menu-item" onclick="switchAdminTab('users')">
                    <span class="material-symbols-outlined">people</span>
                    Người dùng
                </div>
                <div class="admin-menu-item" onclick="switchAdminTab('products')">
                    <span class="material-symbols-outlined">inventory</span>
                    Sản phẩm
                </div>
                <div class="admin-menu-item" onclick="switchAdminTab('keys')">
                    <span class="material-symbols-outlined">vpn_key</span>
                    Kho key
                </div>
                <div class="admin-menu-item" onclick="switchAdminTab('transactions')">
                    <span class="material-symbols-outlined">receipt_long</span>
                    Giao dịch
                </div>
                <div class="admin-menu-item" onclick="switchAdminTab('rankings')">
                    <span class="material-symbols-outlined">leaderboard</span>
                    Xếp hạng
                </div>
                <div class="admin-menu-item" onclick="logout()" style="color: #ef4444; margin-top: 2rem;">
                    <span class="material-symbols-outlined">logout</span>
                    Đăng xuất
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="admin-main">
            <!-- Dashboard Tab -->
            <div id="dashboardTab" class="content-area active">
                <h2 class="section-title">Tổng quan</h2>
                
                <div class="stats-grid" id="dashboardStats">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">people</span>
                        </div>
                        <div class="stat-info">
                            <h3>Tổng người dùng</h3>
                            <p id="totalUsers">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">receipt_long</span>
                        </div>
                        <div class="stat-info">
                            <h3>Tổng giao dịch</h3>
                            <p id="totalTransactions">0</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">payments</span>
                        </div>
                        <div class="stat-info">
                            <h3>Doanh thu</h3>
                            <p id="totalRevenue">0đ</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <span class="material-symbols-outlined">inventory</span>
                        </div>
                        <div class="stat-info">
                            <h3>Sản phẩm</h3>
                            <p id="totalProducts">0</p>
                        </div>
                    </div>
                </div>
                
                <div class="admin-card">
                    <h3 style="font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem;">Giao dịch gần đây</h3>
                    <table class="admin-table" id="recentTransactions">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Người dùng</th>
                                <th>Loại</th>
                                <th>Số tiền</th>
                                <th>Trạng thái</th>
                                <th>Thời gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="6" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Users Tab -->
            <div id="usersTab" class="content-area">
                <div class="flex-between">
                    <h2 class="section-title">Quản lý người dùng</h2>
                    <button class="btn btn-primary" onclick="showAddUserModal()">
                        <span class="material-symbols-outlined" style="font-size: 1.2rem; margin-right: 0.25rem;">add</span>
                        Thêm user
                    </button>
                </div>
                
                <div class="admin-card">
                    <table class="admin-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Họ tên</th>
                                <th>Tài khoản</th>
                                <th>Loại TK</th>
                                <th>Số dư</th>
                                <th>Trạng thái</th>
                                <th>Ngày ĐK</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Products Tab -->
            <div id="productsTab" class="content-area">
                <div class="flex-between">
                    <h2 class="section-title">Quản lý sản phẩm</h2>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <span class="material-symbols-outlined" style="font-size: 1.2rem; margin-right: 0.25rem;">add</span>
                        Thêm sản phẩm
                    </button>
                </div>
                
                <div class="admin-card">
                    <table class="admin-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tên SP</th>
                                <th>Danh mục</th>
                                <th>Giá ngày</th>
                                <th>Giá tuần</th>
                                <th>Giá tháng</th>
                                <th>Giá mùa</th>
                                <th>Giá năm</th>
                                <th>SL</th>
                                <th>Đã bán</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="12" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Keys Tab -->
            <div id="keysTab" class="content-area">
                <div class="flex-between">
                    <h2 class="section-title">Quản lý key</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary btn-sm" onclick="showAddKeysModal('Ngày')">
                            <span class="material-symbols-outlined" style="font-size: 1.2rem;">add</span>
                            Thêm key ngày
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showAddKeysModal('Tuần')">
                            <span class="material-symbols-outlined" style="font-size: 1.2rem;">add</span>
                            Thêm key tuần
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showAddKeysModal('Tháng')">
                            <span class="material-symbols-outlined" style="font-size: 1.2rem;">add</span>
                            Thêm key tháng
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="showAddKeysModal('Mùa')">
                            <span class="material-symbols-outlined" style="font-size: 1.2rem;">add</span>
                            Thêm key mùa
                        </button>
                    </div>
                </div>
                
                <div class="admin-card">
                    <table class="admin-table" id="keysTable">
                        <thead>
                            <tr>
                                <th>ID Key</th>
                                <th>Mã SP</th>
                                <th>Tên SP</th>
                                <th>Key code</th>
                                <th>Loại key</th>
                                <th>Trạng thái</th>
                                <th>Người mua</th>
                                <th>Ngày mua</th>
                                <th>Hạn dùng</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="10" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Transactions Tab -->
            <div id="transactionsTab" class="content-area">
                <h2 class="section-title">Lịch sử giao dịch</h2>
                
                <div class="admin-card">
                    <table class="admin-table" id="transactionsTable">
                        <thead>
                            <tr>
                                <th>ID GD</th>
                                <th>Người dùng</th>
                                <th>Loại GD</th>
                                <th>Số tiền</th>
                                <th>Phương thức</th>
                                <th>Trạng thái</th>
                                <th>Sản phẩm</th>
                                <th>Thời gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="8" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Rankings Tab -->
            <div id="rankingsTab" class="content-area">
                <h2 class="section-title">Quản lý xếp hạng</h2>
                
                <div class="admin-card">
                    <table class="admin-table" id="rankingsTable">
                        <thead>
                            <tr>
                                <th>Hạng</th>
                                <th>Mã người dùng</th>
                                <th>Họ tên</th>
                                <th>Tổng chi tiêu</th>
                                <th>Tháng</th>
                                <th>Năm</th>
                                <th>Cập nhật</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="7" style="text-align: center; padding: 2rem; color: #94a3b8;">Đang tải...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="addUserModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Thêm người dùng mới</h3>
            
            <div class="form-group">
                <label class="form-label">Họ tên</label>
                <input type="text" class="form-input" id="newUserFullname" placeholder="Nhập họ tên">
            </div>
            
            <div class="form-group">
                <label class="form-label">Tên đăng nhập</label>
                <input type="text" class="form-input" id="newUserUsername" placeholder="Chỉ chữ và số, không dấu cách">
            </div>
            
            <div class="form-group">
                <label class="form-label">Mật khẩu</label>
                <input type="password" class="form-input" id="newUserPassword" placeholder="Nhập mật khẩu">
            </div>
            
            <div class="form-group">
                <label class="form-label">Loại tài khoản</label>
                <select class="form-input" id="newUserType">
                    <option value="Thường">Thường</option>
                    <option value="Thân thiết">Thân thiết</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Số dư</label>
                <input type="number" class="form-input" id="newUserBalance" placeholder="Nhập số dư" value="0">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="addUser()" style="flex: 1;">Thêm</button>
                <button class="btn btn-outline" onclick="closeModal('addUserModal')" style="flex: 1;">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Thêm sản phẩm mới</h3>
            
            <div class="form-group">
                <label class="form-label">Tên sản phẩm</label>
                <input type="text" class="form-input" id="newProductName" placeholder="Nhập tên sản phẩm">
            </div>
            
            <div class="form-group">
                <label class="form-label">Danh mục</label>
                <input type="text" class="form-input" id="newProductCategory" placeholder="Nhập danh mục">
            </div>
            
            <div class="form-group">
                <label class="form-label">Mô tả</label>
                <textarea class="form-input" id="newProductDescription" placeholder="Nhập mô tả sản phẩm" rows="3"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Ảnh bìa</label>
                <input type="text" class="form-input" id="newProductCover" placeholder="URL ảnh bìa">
            </div>
            
            <div class="price-grid">
                <div class="form-group">
                    <label class="form-label">Giá ngày</label>
                    <input type="number" class="form-input" id="newPriceDay" placeholder="Giá ngày">
                </div>
                <div class="form-group">
                    <label class="form-label">Giá tuần</label>
                    <input type="number" class="form-input" id="newPriceWeek" placeholder="Giá tuần">
                </div>
                <div class="form-group">
                    <label class="form-label">Giá tháng</label>
                    <input type="number" class="form-input" id="newPriceMonth" placeholder="Giá tháng">
                </div>
                <div class="form-group">
                    <label class="form-label">Giá mùa</label>
                    <input type="number" class="form-input" id="newPriceSeason" placeholder="Giá mùa">
                </div>
                <div class="form-group">
                    <label class="form-label">Giá năm</label>
                    <input type="number" class="form-input" id="newPriceYear" placeholder="Giá năm">
                </div>
                <div class="form-group">
                    <label class="form-label">Số lượng</label>
                    <input type="number" class="form-input" id="newProductStock" placeholder="Số lượng">
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-primary" onclick="addProduct()" style="flex: 1;">Thêm</button>
                <button class="btn btn-outline" onclick="closeModal('addProductModal')" style="flex: 1;">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Add Keys Modal -->
    <div id="addKeysModal" class="modal">
        <div class="modal-content">
            <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;" id="addKeysModalTitle">Thêm key mới</h3>
            
            <div class="form-group">
                <label class="form-label">Chọn sản phẩm</label>
                <select class="form-input" id="keyProductId">
                    <option value="">-- Chọn sản phẩm --</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Loại key</label>
                <input type="text" class="form-input" id="keyType" readonly style="background: #f1f5f9;">
            </div>
            
            <div class="form-group">
                <label class="form-label">Key code (mỗi key 1 dòng)</label>
                <textarea class="form-input key-input" id="keyCodes" placeholder="Ví dụ:&#10;KEY-DAY-001&#10;KEY-DAY-002&#10;KEY-DAY-003"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Hạn dùng (để trống nếu vĩnh viễn)</label>
                <input type="text" class="form-input" id="keyExpiry" placeholder="YYYY-MM-DD">
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" onclick="addKeys()" style="flex: 1;">Thêm</button>
                <button class="btn btn-outline" onclick="closeModal('addKeysModal')" style="flex: 1;">Hủy</button>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" class="modal">
        <div class="modal-content" id="editProductModalContent">
            <!-- Content will be loaded dynamically -->
        </div>
    </div>

    <script>
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyE1_70ua0L2mj9jtfOA6LxiEbshiiKvQ_8_r62jT1al_yFg50gDAINyt1CwDNkwOw0jQ/exec';
        
        let currentAdmin = null;
        let allProducts = [];
        let currentKeyType = '';

        // Check admin login on load
        document.addEventListener('DOMContentLoaded', function() {
            checkAdminLogin();
        });

        // Show toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // Check admin login
        function checkAdminLogin() {
            const savedUser = localStorage.getItem('currentUser');
            
            if (savedUser) {
                try {
                    const user = JSON.parse(savedUser);
                    if (user.type === 'admin') {
                        currentAdmin = user;
                        document.getElementById('loginRequired').classList.remove('active');
                        document.getElementById('adminContent').classList.add('active');
                        document.getElementById('adminName').textContent = user.fullName || user.username;
                        loadDashboard();
                        loadAllData();
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
            
            document.getElementById('loginRequired').classList.add('active');
            document.getElementById('adminContent').classList.remove('active');
        }

        // Load all data
        function loadAllData() {
            loadUsers();
            loadProducts();
            loadTransactions();
            loadRankings();
        }

        // Load dashboard
        function loadDashboard() {
            Promise.all([fetchAllUsers(), fetchAllTransactions(), fetchProducts()])
            .then(([users, transactions, products]) => {
                allProducts = products;
                
                const totalUsers = users?.length || 0;
                const totalTransactions = transactions?.length || 0;
                const totalRevenue = transactions?.filter(t => t.type === 'Mua hàng').reduce((sum, t) => sum + (t.amount || 0), 0) || 0;
                const totalProducts = products?.length || 0;
                
                document.getElementById('totalUsers').textContent = totalUsers;
                document.getElementById('totalTransactions').textContent = totalTransactions;
                document.getElementById('totalRevenue').textContent = formatMoney(totalRevenue);
                document.getElementById('totalProducts').textContent = totalProducts;
                
                const recentTransactions = transactions?.slice(0, 5) || [];
                let transactionsHTML = '';
                recentTransactions.forEach(t => {
                    transactionsHTML += `
                        <tr>
                            <td>${t.id || ''}</td>
                            <td>${t.user || ''}</td>
                            <td>${t.type || ''}</td>
                            <td>${formatMoney(t.amount)}</td>
                            <td><span class="badge ${t.status === 'Hoàn tất' ? 'badge-success' : 'badge-warning'}">${t.status || ''}</span></td>
                            <td>${t.time || ''}</td>
                        </tr>
                    `;
                });
                document.querySelector('#recentTransactions tbody').innerHTML = transactionsHTML || '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
            });
        }

        // Load users
        function loadUsers() {
            fetchAllUsers().then(users => {
                let html = '';
                users.forEach(user => {
                    const userType = user.type || 'Thường';
                    html += `
                        <tr>
                            <td>${user.id || ''}</td>
                            <td>${user.fullName || ''}</td>
                            <td>${user.username || ''}</td>
                            <td>
                                <span class="badge ${userType === 'Thân thiết' ? 'badge-warning' : 'badge-info'}">${userType}</span>
                            </td>
                            <td>${formatMoney(user.balance)}</td>
                            <td><span class="badge ${user.status === 'Hoạt động' ? 'badge-success' : 'badge-danger'}">${user.status || ''}</span></td>
                            <td>${user.registerDate || ''}</td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; margin-right: 0.25rem;" onclick="editUser('${user.id}')">Sửa</button>
                                <button class="btn btn-danger" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" onclick="toggleUserStatus('${user.id}', '${user.status}')">
                                    ${user.status === 'Hoạt động' ? 'Khóa' : 'Mở'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                document.querySelector('#usersTable tbody').innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
            });
        }

        // Load products
        function loadProducts() {
            fetchProducts().then(products => {
                allProducts = products;
                let html = '';
                products.forEach(p => {
                    html += `
                        <tr>
                            <td>${p.id || ''}</td>
                            <td>${p.name || ''}</td>
                            <td>${p.category || ''}</td>
                            <td>${formatMoney(p.prices?.day)}</td>
                            <td>${formatMoney(p.prices?.week)}</td>
                            <td>${formatMoney(p.prices?.month)}</td>
                            <td>${formatMoney(p.prices?.season)}</td>
                            <td>${formatMoney(p.prices?.year)}</td>
                            <td>${p.stock || 0}</td>
                            <td>${p.sold || 0}</td>
                            <td><span class="badge ${p.status === 'Hoạt động' ? 'badge-success' : 'badge-danger'}">${p.status || ''}</span></td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.4rem 0.75rem; font-size: 0.8rem; margin-right: 0.25rem;" onclick="editProduct('${p.id}')">Sửa</button>
                                <button class="btn btn-danger" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" onclick="toggleProductStatus('${p.id}', '${p.status}')">
                                    ${p.status === 'Hoạt động' ? 'Ẩn' : 'Hiện'}
                                </button>
                            </td>
                        </tr>
                    `;
                });
                document.querySelector('#productsTable tbody').innerHTML = html || '<tr><td colspan="12" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
            });
        }

        // Load keys
        function loadKeys() {
            const formData = new FormData();
            formData.append('action', 'adminGetAllKeys');
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.keys) {
                    const products = allProducts.reduce((acc, p) => {
                        acc[p.id] = p.name;
                        return acc;
                    }, {});
                    
                    let html = '';
                    data.keys.forEach(key => {
                        const statusClass = key.status === 'Còn hàng' ? 'badge-success' : 'badge-danger';
                        html += `
                            <tr>
                                <td>${key.id}</td>
                                <td>${key.productId}</td>
                                <td>${products[key.productId] || 'N/A'}</td>
                                <td><code style="font-size: 0.8rem;">${key.keyCode}</code></td>
                                <td><span class="badge badge-info">${key.keyType}</span></td>
                                <td><span class="badge ${statusClass}">${key.status}</span></td>
                                <td>${key.buyer || '-'}</td>
                                <td>${key.purchaseDate || '-'}</td>
                                <td>${key.expiryDate || 'Vĩnh viễn'}</td>
                                <td>
                                    <button class="btn btn-danger" style="padding: 0.4rem 0.75rem; font-size: 0.8rem;" onclick="deleteKey('${key.id}')">
                                        Xóa
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    document.querySelector('#keysTable tbody').innerHTML = html || '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading keys:', error);
                showToast('Lỗi tải danh sách key', 'error');
            });
        }

        // Load transactions
        function loadTransactions() {
            fetchAllTransactions().then(transactions => {
                let html = '';
                transactions.forEach(t => {
                    html += `
                        <tr>
                            <td>${t.id || ''}</td>
                            <td>${t.user || ''}</td>
                            <td>${t.type || ''}</td>
                            <td>${formatMoney(t.amount)}</td>
                            <td>${t.method || ''}</td>
                            <td><span class="badge ${t.status === 'Hoàn tất' ? 'badge-success' : 'badge-warning'}">${t.status || ''}</span></td>
                            <td>${t.product || ''}</td>
                            <td>${t.time || ''}</td>
                        </tr>
                    `;
                });
                document.querySelector('#transactionsTable tbody').innerHTML = html || '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
            });
        }

        // Load rankings
        function loadRankings() {
            fetchRankings().then(rankings => {
                let html = '';
                rankings.forEach(r => {
                    html += `
                        <tr>
                            <td>${r.rank || ''}</td>
                            <td>${r.userId || ''}</td>
                            <td>${r.fullName || ''}</td>
                            <td>${formatMoney(r.totalSpent)}</td>
                            <td>${r.month || ''}</td>
                            <td>${r.year || ''}</td>
                            <td>${r.updated || ''}</td>
                        </tr>
                    `;
                });
                document.querySelector('#rankingsTable tbody').innerHTML = html || '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: #94a3b8;">Không có dữ liệu</td></tr>';
            });
        }

        // API Calls
        function fetchAllUsers() {
            const formData = new FormData();
            formData.append('action', 'adminGetAllUsers');
            
            return fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => data.success ? data.users : [])
            .catch(error => {
                console.error('Error fetching users:', error);
                return [];
            });
        }

        function fetchAllTransactions() {
            const formData = new FormData();
            formData.append('action', 'adminGetAllTransactions');
            
            return fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => data.success ? data.transactions : [])
            .catch(error => {
                console.error('Error fetching transactions:', error);
                return [];
            });
        }

        function fetchProducts() {
            const formData = new FormData();
            formData.append('action', 'getProducts');
            
            return fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => data.success ? data.products : [])
            .catch(error => {
                console.error('Error fetching products:', error);
                return [];
            });
        }

        function fetchRankings() {
            const formData = new FormData();
            formData.append('action', 'getRankings');
            
            const now = new Date();
            formData.append('month', now.getMonth() + 1);
            formData.append('year', now.getFullYear());
            
            return fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => data.success ? data.rankings : [])
            .catch(error => {
                console.error('Error fetching rankings:', error);
                return [];
            });
        }

        // Modal functions
        function showAddUserModal() {
            document.getElementById('addUserModal').classList.add('active');
        }

        function showAddProductModal() {
            document.getElementById('addProductModal').classList.add('active');
        }

        function showAddKeysModal(keyType) {
            currentKeyType = keyType;
            document.getElementById('addKeysModalTitle').textContent = `Thêm key ${keyType}`;
            document.getElementById('keyType').value = keyType;
            
            fetchProducts().then(products => {
                const select = document.getElementById('keyProductId');
                select.innerHTML = '<option value="">-- Chọn sản phẩm --</option>';
                products.forEach(p => {
                    select.innerHTML += `<option value="${p.id}">${p.name}</option>`;
                });
            });
            
            document.getElementById('addKeysModal').classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Add user
        function addUser() {
            const fullname = document.getElementById('newUserFullname').value;
            const username = document.getElementById('newUserUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const type = document.getElementById('newUserType').value;
            const balance = document.getElementById('newUserBalance').value;
            
            if (!fullname || !username || !password) {
                showToast('Vui lòng nhập đầy đủ thông tin', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'register');
            formData.append('fullname', fullname);
            formData.append('username', username);
            formData.append('password', password);
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Thêm user thành công');
                    closeModal('addUserModal');
                    loadUsers();
                    
                    document.getElementById('newUserFullname').value = '';
                    document.getElementById('newUserUsername').value = '';
                    document.getElementById('newUserPassword').value = '';
                    document.getElementById('newUserBalance').value = '0';
                } else {
                    showToast(data.message || 'Thêm user thất bại', 'error');
                }
            });
        }

        // Add product
        function addProduct() {
            const name = document.getElementById('newProductName').value;
            const category = document.getElementById('newProductCategory').value;
            const description = document.getElementById('newProductDescription').value;
            const cover = document.getElementById('newProductCover').value;
            const priceDay = document.getElementById('newPriceDay').value;
            const priceWeek = document.getElementById('newPriceWeek').value;
            const priceMonth = document.getElementById('newPriceMonth').value;
            const priceSeason = document.getElementById('newPriceSeason').value;
            const priceYear = document.getElementById('newPriceYear').value;
            const stock = document.getElementById('newProductStock').value;
            
            if (!name || !category) {
                showToast('Vui lòng nhập tên và danh mục', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'adminAddProduct');
            formData.append('name', name);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('cover', cover);
            formData.append('priceDay', priceDay || 0);
            formData.append('priceWeek', priceWeek || 0);
            formData.append('priceMonth', priceMonth || 0);
            formData.append('priceSeason', priceSeason || 0);
            formData.append('priceYear', priceYear || 0);
            formData.append('stock', stock || 0);
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Thêm sản phẩm thành công');
                    closeModal('addProductModal');
                    loadProducts();
                    
                    document.getElementById('newProductName').value = '';
                    document.getElementById('newProductCategory').value = '';
                    document.getElementById('newProductDescription').value = '';
                    document.getElementById('newProductCover').value = '';
                    document.getElementById('newPriceDay').value = '';
                    document.getElementById('newPriceWeek').value = '';
                    document.getElementById('newPriceMonth').value = '';
                    document.getElementById('newPriceSeason').value = '';
                    document.getElementById('newPriceYear').value = '';
                    document.getElementById('newProductStock').value = '';
                } else {
                    showToast(data.message || 'Thêm sản phẩm thất bại', 'error');
                }
            });
        }

        // Add keys
        function addKeys() {
            const productId = document.getElementById('keyProductId').value;
            const keyCodes = document.getElementById('keyCodes').value;
            const expiry = document.getElementById('keyExpiry').value;
            
            if (!productId) {
                showToast('Vui lòng chọn sản phẩm', 'error');
                return;
            }
            
            if (!keyCodes) {
                showToast('Vui lòng nhập key code', 'error');
                return;
            }
            
            const keys = keyCodes.split('\n').filter(k => k.trim());
            
            const formData = new FormData();
            formData.append('action', 'adminAddKeys');
            formData.append('productId', productId);
            formData.append('keyType', currentKeyType);
            formData.append('keys', JSON.stringify(keys));
            formData.append('expiryDate', expiry);
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message);
                    closeModal('addKeysModal');
                    document.getElementById('keyCodes').value = '';
                    loadKeys();
                    loadProducts();
                } else {
                    showToast(data.message || 'Thêm key thất bại', 'error');
                }
            });
        }

        // Delete key
        function deleteKey(keyId) {
            if (!confirm('Bạn có chắc chắn muốn xóa key này?')) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'adminDeleteKey');
            formData.append('keyId', keyId);
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Xóa key thành công');
                    loadKeys();
                } else {
                    showToast(data.message || 'Xóa key thất bại', 'error');
                }
            });
        }

        // Edit product
        function editProduct(productId) {
            const product = allProducts.find(p => p.id == productId);
            if (!product) return;
            
            const modal = document.getElementById('editProductModal');
            const content = document.getElementById('editProductModalContent');
            
            content.innerHTML = `
                <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem;">Sửa sản phẩm: ${product.name}</h3>
                
                <div class="form-group">
                    <label class="form-label">Tên sản phẩm</label>
                    <input type="text" class="form-input" id="editProductName" placeholder="Tên sản phẩm" value="${product.name || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Danh mục</label>
                    <input type="text" class="form-input" id="editProductCategory" placeholder="Danh mục" value="${product.category || ''}">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Mô tả</label>
                    <textarea class="form-input" id="editProductDescription" placeholder="Mô tả" rows="3">${product.description || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Ảnh bìa</label>
                    <input type="text" class="form-input" id="editProductCover" placeholder="URL ảnh bìa" value="${product.cover || ''}">
                </div>
                
                <div class="price-grid">
                    <div class="form-group">
                        <label class="form-label">Giá ngày</label>
                        <input type="number" class="form-input" id="editPriceDay" placeholder="Giá ngày" value="${product.prices?.day || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá tuần</label>
                        <input type="number" class="form-input" id="editPriceWeek" placeholder="Giá tuần" value="${product.prices?.week || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá tháng</label>
                        <input type="number" class="form-input" id="editPriceMonth" placeholder="Giá tháng" value="${product.prices?.month || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá mùa</label>
                        <input type="number" class="form-input" id="editPriceSeason" placeholder="Giá mùa" value="${product.prices?.season || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Giá năm</label>
                        <input type="number" class="form-input" id="editPriceYear" placeholder="Giá năm" value="${product.prices?.year || 0}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Số lượng</label>
                        <input type="number" class="form-input" id="editProductStock" placeholder="Số lượng" value="${product.stock || 0}">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Trạng thái</label>
                    <select class="form-input" id="editProductStatus">
                        <option value="Hoạt động" ${product.status === 'Hoạt động' ? 'selected' : ''}>Hoạt động</option>
                        <option value="Ẩn" ${product.status === 'Ẩn' ? 'selected' : ''}>Ẩn</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button class="btn btn-primary" onclick="saveProduct('${product.id}')" style="flex: 1;">Lưu</button>
                    <button class="btn btn-outline" onclick="closeModal('editProductModal')" style="flex: 1;">Hủy</button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Save product
        function saveProduct(productId) {
            const updates = {
                'Tên SP': document.getElementById('editProductName').value,
                'Danh mục': document.getElementById('editProductCategory').value,
                'Mô tả': document.getElementById('editProductDescription').value,
                'Ảnh bìa': document.getElementById('editProductCover').value,
                'Giá ngày': parseInt(document.getElementById('editPriceDay').value) || 0,
                'Giá tuần': parseInt(document.getElementById('editPriceWeek').value) || 0,
                'Giá tháng': parseInt(document.getElementById('editPriceMonth').value) || 0,
                'Giá mùa': parseInt(document.getElementById('editPriceSeason').value) || 0,
                'Giá năm': parseInt(document.getElementById('editPriceYear').value) || 0,
                'SL còn lại': parseInt(document.getElementById('editProductStock').value) || 0,
                'Trạng thái': document.getElementById('editProductStatus').value
            };
            
            const formData = new FormData();
            formData.append('action', 'adminUpdateProduct');
            formData.append('productId', productId);
            formData.append('updates', JSON.stringify(updates));
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                closeModal('editProductModal');
                if (data.success) {
                    showToast('Cập nhật sản phẩm thành công');
                    loadProducts();
                } else {
                    showToast(data.message || 'Cập nhật thất bại', 'error');
                }
            });
        }

        // Toggle user status
        function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'Hoạt động' ? 'Khóa' : 'Hoạt động';
            
            if (!confirm(`Xác nhận ${newStatus === 'Hoạt động' ? 'mở khóa' : 'khóa'} tài khoản này?`)) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'adminUpdateUser');
            formData.append('userId', userId);
            formData.append('field', 'Trạng thái');
            formData.append('value', newStatus);
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Cập nhật trạng thái thành công');
                    loadUsers();
                } else {
                    showToast('Cập nhật thất bại', 'error');
                }
            });
        }

        // Toggle product status
        function toggleProductStatus(productId, currentStatus) {
            const newStatus = currentStatus === 'Hoạt động' ? 'Ẩn' : 'Hoạt động';
            
            if (!confirm(`Xác nhận ${newStatus === 'Hoạt động' ? 'hiện' : 'ẩn'} sản phẩm này?`)) {
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'adminUpdateProduct');
            formData.append('productId', productId);
            formData.append('updates', JSON.stringify({ 'Trạng thái': newStatus }));
            
            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    showToast('Cập nhật trạng thái thành công');
                    loadProducts();
                } else {
                    showToast('Cập nhật thất bại', 'error');
                }
            });
        }

        // Edit user (placeholder)
        function editUser(userId) {
            showToast('Tính năng đang phát triển');
        }

        // Switch admin tabs
        function switchAdminTab(tab) {
            const tabs = ['dashboard', 'users', 'products', 'keys', 'transactions', 'rankings'];
            const menuItems = document.querySelectorAll('.admin-menu-item');
            
            menuItems.forEach(item => item.classList.remove('active'));
            tabs.forEach(t => document.getElementById(t + 'Tab').classList.remove('active'));
            
            event.currentTarget.classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'keys') loadKeys();
        }

        // Format money
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount || 0);
        }

        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.reload();
        }
    </script>
</body>
</html>