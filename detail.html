<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Chi ti·∫øt s·∫£n ph·∫©m - VSA CHEAT</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: #f8fafc;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }
        
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(79, 70, 229, 0.2);
            border-radius: 20px;
        }

        /* Sidebar Styles */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 260px;
            background: white;
            border-right: 1px solid rgba(203, 213, 225, 0.2);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 50;
            overflow-y: auto;
        }

        @media (min-width: 1024px) {
            .sidebar {
                transform: translateX(0);
                width: 240px;
            }
            
            .main-content {
                margin-left: 240px;
            }
        }

        .sidebar-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-backdrop.active {
            opacity: 1;
            visibility: visible;
        }

        /* Nav Item Styles */
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            margin: 4px 8px;
            border-radius: 14px;
            color: #64748b;
            font-weight: 500;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .nav-item:hover {
            background: #f8fafc;
            color: #4f46e5;
        }

        .nav-item.active {
            background: #eef2ff;
            color: #4f46e5;
            font-weight: 600;
        }

        .nav-item i {
            font-size: 1.1rem;
            width: 22px;
        }

        /* Check Icon */
        .check-icon {
            background: #4f46e5;
            color: white;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            flex-shrink: 0;
            margin-right: 6px;
        }

        .desc-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            margin-bottom: 8px;
            font-size: 0.85rem;
            color: #334155;
            line-height: 1.4;
        }

        /* Detail Page Styles */
        .detail-page {
            max-width: 1000px;
            margin: 0 auto;
            padding-bottom: 30px;
        }

        .detail-header {
            background: white;
            border-radius: 20px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(203, 213, 225, 0.2);
        }

        .detail-image {
            width: 100%;
            height: auto;
            max-height: 300px;
            object-fit: contain;
            border-radius: 14px;
            margin-bottom: 16px;
            background: #f1f5f9;
            padding: 8px;
        }

        @media (max-width: 640px) {
            .detail-image {
                max-height: 200px;
                padding: 4px;
            }
        }

        .feature-list {
            background: #f8fafc;
            border-radius: 16px;
            padding: 14px;
            margin: 14px 0;
        }

        .feature-list h3 {
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: white;
            border-radius: 30px;
            font-size: 0.8rem;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .back-button:hover {
            background: #f8fafc;
            border-color: #4f46e5;
            color: #4f46e5;
        }

        /* Package Card */
        .package-item {
            border: 1.5px solid #e2e8f0;
            border-radius: 14px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .package-item:hover {
            border-color: #4f46e5;
            background: #f8fafc;
        }

        .package-item.selected {
            border-color: #4f46e5;
            background: #eef2ff;
        }

        .package-item .text-lg {
            font-size: 1rem;
        }

        /* Buy Button */
        .buy-btn {
            width: 100%;
            background: linear-gradient(135deg, #4f46e5, #7c3aed);
            color: white;
            padding: 12px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 0.95rem;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .buy-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px #4f46e5;
        }

        .buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Stats */
        .product-stats {
            display: flex;
            gap: 10px;
            margin: 14px 0;
            padding: 10px;
            background: linear-gradient(135deg, #eef2ff, #f5f3ff);
            border-radius: 14px;
        }

        .stat-item {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #4f46e5;
        }

        .stat-label {
            font-size: 0.65rem;
            color: #64748b;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 16px;
            width: 92%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: white;
            padding: 10px 20px;
            border-radius: 100px;
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.2);
            font-weight: 500;
            font-size: 0.85rem;
            color: #1e293b;
            z-index: 1000;
            transition: transform 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Mobile */
        @media (max-width: 640px) {
            .p-4 {
                padding: 12px;
            }
            
            .lg\:p-8 {
                padding: 12px;
            }
            
            h1.text-3xl {
                font-size: 1.4rem;
            }
            
            .text-xl {
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Sidebar Backdrop -->
    <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="p-5">
            <!-- Brand -->
            <div class="flex items-center gap-3 mb-6">
                <div class="w-10 h-10 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-lg">
                    V
                </div>
                <div>
                    <h1 class="text-lg font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">
                        VSA CHEAT
                    </h1>
                    <p class="text-[0.65rem] text-gray-400">Gi·∫£i ph√°p game s·ªë 1</p>
                </div>
            </div>

            <!-- Navigation -->
            <div class="space-y-1 mb-6">
                <div class="nav-item" onclick="window.location.href='index.html'">
                    <i class="fa-solid fa-house"></i>
                    <span>Trang ch·ªß</span>
                </div>
                <div class="nav-item" onclick="window.location.href='index.html?page=products'">
                    <i class="fa-solid fa-cubes"></i>
                    <span>S·∫£n ph·∫©m</span>
                </div>
                <div class="nav-item" onclick="window.location.href='index.html?page=keys'">
                    <i class="fa-solid fa-key"></i>
                    <span>Key c·ªßa t√¥i</span>
                </div>
                <div class="nav-item" onclick="window.location.href='index.html?page=history'">
                    <i class="fa-solid fa-clock-rotate-left"></i>
                    <span>L·ªãch s·ª≠</span>
                </div>
                <div class="nav-item" onclick="window.location.href='index.html?page=ranking'">
                    <i class="fa-solid fa-trophy"></i>
                    <span>X·∫øp h·∫°ng</span>
                </div>
            </div>

            <!-- User Card -->
            <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl p-3">
                <div class="flex items-center gap-2 mb-2">
                    <div class="w-10 h-10 bg-white rounded-xl flex items-center justify-center text-indigo-600 text-xl">
                        <i class="fa-regular fa-user" id="userIcon"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 text-sm" id="sidebarUserName">Kh√°ch</p>
                        <p class="text-[0.6rem] text-gray-500" id="sidebarUserStatus">Ch∆∞a ƒëƒÉng nh·∫≠p</p>
                    </div>
                </div>
                
                <div class="border-t border-white/50 pt-2">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs text-gray-600">S·ªë d∆∞</span>
                        <span class="font-bold text-indigo-600 text-sm" id="sidebarBalance">0‚Ç´</span>
                    </div>
                    
                    <div id="sidebarAuth">
                        <button onclick="window.location.href='account.html'" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl font-semibold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-right-to-bracket text-xs"></i>
                            ƒêƒÉng nh·∫≠p
                        </button>
                    </div>
                    
                    <div id="sidebarUser" style="display: none;">
                        <button onclick="logout()" class="w-full bg-red-500 text-white py-2 px-3 rounded-xl font-semibold text-xs hover:shadow-lg transition-all flex items-center justify-center gap-1">
                            <i class="fa-solid fa-right-from-bracket text-xs"></i>
                            ƒêƒÉng xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content min-h-screen">
        <!-- Mobile Header -->
        <header class="lg:hidden bg-white/80 backdrop-blur-md border-b border-gray-100 sticky top-0 z-30">
            <div class="flex items-center justify-between px-3 py-2">
                <div class="flex items-center gap-2">
                    <button onclick="toggleSidebar()" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                        <i class="fa-solid fa-bars text-sm"></i>
                    </button>
                    <div>
                        <span class="font-bold text-indigo-600 text-sm">VSA</span>
                        <span class="font-bold text-gray-900 text-sm">CHEAT</span>
                    </div>
                </div>
                <div class="flex items-center gap-1">
                    <button onclick="showTopupModal()" id="mobileTopupBtn" style="display: none;" class="w-8 h-8 bg-indigo-100 rounded-xl flex items-center justify-center text-indigo-600">
                        <i class="fa-solid fa-wallet text-sm"></i>
                    </button>
                    <button onclick="window.location.href='account.html'" id="mobileLoginBtn" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                        <i class="fa-solid fa-user text-sm"></i>
                    </button>
                </div>
            </div>
            <div class="px-3 pb-2">
                <h2 class="text-base font-bold text-gray-900" id="currentPageTitle">Chi ti·∫øt s·∫£n ph·∫©m</h2>
            </div>
        </header>

        <!-- Content Area -->
        <div class="p-4 lg:p-6" id="contentArea">
            <!-- Product detail will be loaded here -->
            <div class="detail-page">
                <div class="back-button" onclick="window.location.href='index.html'">
                    <i class="fa-solid fa-arrow-left text-xs"></i>
                    Quay l·∫°i trang ch·ªß
                </div>
                
                <div class="detail-header">
                    <div class="skeleton h-6 w-3/4 mb-3 rounded"></div>
                    <div class="skeleton h-48 w-full mb-4 rounded-xl"></div>
                    <div class="space-y-2 mb-4">
                        <div class="skeleton h-3 w-full rounded"></div>
                        <div class="skeleton h-3 w-full rounded"></div>
                        <div class="skeleton h-3 w-2/3 rounded"></div>
                    </div>
                    <div class="skeleton h-10 w-full rounded-xl"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Topup Modal -->
    <div class="modal" id="topupModal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">N·∫°p ti·ªÅn</h2>
                <button onclick="closeModal('topupModal')" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">S·ªë ti·ªÅn</label>
                    <div class="relative">
                        <i class="fa-solid fa-coins absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                        <input type="number" id="topupAmount" class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500" placeholder="Nh·∫≠p s·ªë ti·ªÅn" min="10000" step="10000">
                    </div>
                </div>
                
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Ph∆∞∆°ng th·ª©c</label>
                    <select id="topupMethod" class="w-full px-3 py-2 border border-gray-200 rounded-xl text-sm focus:outline-none focus:border-indigo-500">
                        <option value="Momo">Momo</option>
                        <option value="Banking">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</option>
                        <option value="Card">Th·∫ª c√†o</option>
                    </select>
                </div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="processTopup()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl font-semibold text-sm hover:shadow-lg transition-all">
                        X√°c nh·∫≠n
                    </button>
                    <button onclick="closeModal('topupModal')" class="px-4 py-2 border border-gray-200 rounded-xl text-sm font-semibold hover:bg-gray-50">
                        H·ªßy
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal" id="paymentModal">
        <div class="modal-content">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-bold text-gray-900">Thanh to√°n</h2>
                <button onclick="closeModal('paymentModal')" class="w-8 h-8 bg-gray-100 rounded-xl flex items-center justify-center text-gray-600">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            
            <div id="paymentContent"></div>
        </div>
    </div>

    <script>
        // ==================== CONFIGURATION ====================
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyE1_70ua0L2mj9jtfOA6LxiEbshiiKvQ_8_r62jT1al_yFg50gDAINyt1CwDNkwOw0jQ/exec';
        
        // ==================== GLOBAL VARIABLES ====================
        let currentUser = null;
        let currentProduct = null;
        
        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            
            const productName = localStorage.getItem('viewProduct');
            
            if (productName) {
                loadProductDetail(productName);
                localStorage.removeItem('viewProduct');
            } else {
                showToast('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 2000);
            }
            
            setupSidebar();
        });

        // ==================== SIDEBAR FUNCTIONS ====================
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebarBackdrop').classList.toggle('active');
        }
        
        function setupSidebar() {
            const sidebarBackdrop = document.getElementById('sidebarBackdrop');
            sidebarBackdrop.addEventListener('click', toggleSidebar);
            
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    document.getElementById('sidebar').classList.add('active');
                    document.getElementById('sidebarBackdrop').classList.remove('active');
                } else {
                    document.getElementById('sidebar').classList.remove('active');
                    document.getElementById('sidebarBackdrop').classList.remove('active');
                }
            });
            
            if (window.innerWidth >= 1024) {
                document.getElementById('sidebar').classList.add('active');
            }
        }
        
        // ==================== CHECK LOGIN STATUS ====================
        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    updateUIForLoggedInUser();
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }
        }
        
        function updateUIForLoggedInUser() {
            if (currentUser) {
                document.getElementById('sidebarUserName').textContent = currentUser.fullName || currentUser.username;
                document.getElementById('sidebarUserStatus').textContent = currentUser.type || 'Th∆∞·ªùng';
                document.getElementById('sidebarBalance').textContent = formatMoney(currentUser.balance || 0);
                
                if (currentUser.type === 'Th√¢n thi·∫øt') {
                    document.getElementById('userIcon').className = 'fa-solid fa-star text-amber-500';
                } else {
                    document.getElementById('userIcon').className = 'fa-regular fa-user';
                }
                
                document.getElementById('sidebarAuth').style.display = 'none';
                document.getElementById('sidebarUser').style.display = 'block';
                
                document.getElementById('mobileLoginBtn').style.display = 'none';
                document.getElementById('mobileTopupBtn').style.display = 'flex';
                
                refreshUserData();
            }
        }
        
        async function refreshUserData() {
            if (!currentUser) return;
            
            const formData = new FormData();
            formData.append('action', 'getUserInfo');
            formData.append('userId', currentUser.id);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    currentUser = { ...currentUser, ...data.user };
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    document.getElementById('sidebarBalance').textContent = formatMoney(currentUser.balance || 0);
                    
                    if (currentUser.type === 'Th√¢n thi·∫øt') {
                        document.getElementById('sidebarUserStatus').textContent = 'Th√¢n thi·∫øt';
                        document.getElementById('userIcon').className = 'fa-solid fa-star text-amber-500';
                    }
                }
            } catch (error) {
                console.error('Error refreshing user data:', error);
            }
        }
        
        // ==================== LOAD PRODUCT DETAIL ====================
        async function loadProductDetail(productName) {
            try {
                const products = await fetchProducts();
                
                const product = products.find(p => 
                    p.name.toLowerCase() === productName.toLowerCase()
                );
                
                if (product) {
                    currentProduct = product;
                    renderProductDetail(product);
                    document.getElementById('currentPageTitle').textContent = product.name;
                } else {
                    showToast('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m', 'error');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 2000);
                }
            } catch (error) {
                console.error('Error loading product detail:', error);
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        async function fetchProducts() {
            const formData = new FormData();
            formData.append('action', 'getProducts');
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    return data.products || [];
                }
                return [];
            } catch (error) {
                console.error('Error fetching products:', error);
                return [];
            }
        }
        
        // ==================== PARSE DESCRIPTION ====================
        function parseDescription(description) {
            if (!description) return [];
            return description.split('\n').filter(line => line.trim() !== '');
        }
        
        function renderDescriptionItems(descriptionLines) {
            return descriptionLines.map(line => `
                <div class="desc-item">
                    <span class="check-icon">
                        <i class="fa-solid fa-check"></i>
                    </span>
                    <span>${line}</span>
                </div>
            `).join('');
        }
        
        // ==================== RENDER PRODUCT DETAIL ====================
        function renderProductDetail(product) {
            const content = document.getElementById('contentArea');
            const descriptionLines = parseDescription(product.description);
            const imageUrl = product.cover || '';
            
            const renderPackage = (label, pkg, price) => {
                if (!price || price <= 0) return '';
                
                const userDiscount = currentUser?.type === 'Th√¢n thi·∫øt' ? 10 : 0;
                const finalPrice = Math.round(price * (100 - userDiscount) / 100);
                
                return `
                    <div class="package-item" onclick="selectPackage(this, '${pkg}', ${finalPrice})">
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="font-medium text-sm">${label}</span>
                                ${userDiscount > 0 ? `
                                    <span class="ml-2 text-[0.55rem] bg-green-100 text-green-600 px-1.5 py-0.5 rounded-full">
                                        -${userDiscount}%
                                    </span>
                                ` : ''}
                            </div>
                            <div class="text-right">
                                ${userDiscount > 0 ? `
                                    <span class="text-xs text-gray-400 line-through mr-1">${formatMoney(price)}</span>
                                ` : ''}
                                <span class="text-base font-bold text-indigo-600">${formatMoney(finalPrice)}</span>
                            </div>
                        </div>
                    </div>
                `;
            };
            
            content.innerHTML = `
                <div class="detail-page">
                    <div class="back-button" onclick="window.location.href='index.html'">
                        <i class="fa-solid fa-arrow-left text-xs"></i>
                        Quay l·∫°i trang ch·ªß
                    </div>
                    
                    <div class="detail-header">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h1 class="text-xl lg:text-2xl font-bold text-gray-900 mb-1">${product.name}</h1>
                                <span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded-full text-[0.6rem] font-semibold">
                                    <i class="fa-regular fa-folder-open mr-1"></i>
                                    ${product.category || 'Game'}
                                </span>
                            </div>
                        </div>
                        
                        <!-- ·∫¢nh b√¨a -->
                        ${imageUrl ? 
                            `<img src="${imageUrl}" alt="${product.name}" class="detail-image" onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'400\' viewBox=\'0 0 800 400\'%3E%3Crect width=\'800\' height=\'400\' fill=\'%234f46e5\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'white\' font-size=\'32\' font-family=\'Arial\'%3E${product.name}%3C/text%3E%3C/svg%3E';">` :
                            `<div class="detail-image bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white text-4xl">
                                <i class="fa-solid fa-gamepad"></i>
                            </div>`
                        }
                        
                        <!-- Stats -->
                        <div class="product-stats">
                            <div class="stat-item">
                                <div class="stat-value">${product.sold || 0}</div>
                                <div class="stat-label">ƒê√£ b√°n</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${product.stock || 0}</div>
                                <div class="stat-label">C√≤n l·∫°i</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">‚≠ê ${product.rating || '5.0'}</div>
                                <div class="stat-label">ƒê√°nh gi√°</div>
                            </div>
                        </div>
                        
                        <!-- M√¥ t·∫£ chi ti·∫øt -->
                        <div class="feature-list">
                            <h3 class="font-semibold">
                                <i class="fa-solid fa-list-check text-indigo-600 mr-1"></i>
                                T√≠nh nƒÉng chi ti·∫øt
                            </h3>
                            <div class="space-y-1">
                                ${renderDescriptionItems(descriptionLines)}
                            </div>
                        </div>
                        
                        ${currentUser?.type === 'Th√¢n thi·∫øt' ? `
                            <div class="bg-amber-50 rounded-xl p-3 mb-4 flex items-center gap-2 border border-amber-200">
                                <i class="fa-solid fa-star text-amber-500 text-sm"></i>
                                <span class="text-amber-800 text-xs">B·∫°n ƒë∆∞·ª£c gi·∫£m 10% cho t·∫•t c·∫£ g√≥i d·ªãch v·ª•!</span>
                            </div>
                        ` : ''}
                        
                        <!-- Ch·ªçn g√≥i -->
                        <h3 class="text-base font-bold mb-3">
                            <i class="fa-solid fa-gem text-indigo-600 mr-1"></i>
                            Ch·ªçn g√≥i d·ªãch v·ª•
                        </h3>
                        
                        <div class="mb-4" id="packageList">
                            ${renderPackage('Key 1 Ng√†y', 'day', product.prices?.day)}
                            ${renderPackage('Key 1 Tu·∫ßn', 'week', product.prices?.week)}
                            ${renderPackage('Key 1 Th√°ng', 'month', product.prices?.month)}
                            ${renderPackage('Key 1 M√πa (3 th√°ng)', 'season', product.prices?.season)}
                            ${renderPackage('Key 1 NƒÉm', 'year', product.prices?.year)}
                        </div>
                        
                        <!-- N√∫t mua -->
                        <button onclick="showPaymentModal()" class="buy-btn text-sm" id="buyBtn" disabled>
                            <i class="fa-solid fa-credit-card"></i>
                            Ti·∫øn h√†nh thanh to√°n
                        </button>
                    </div>
                </div>
            `;
        }
        
        function selectPackage(element, pkg, price) {
            document.querySelectorAll('.package-item').forEach(el => {
                el.classList.remove('selected');
            });
            element.classList.add('selected');
            
            const buyBtn = document.getElementById('buyBtn');
            if (buyBtn) {
                buyBtn.disabled = false;
                buyBtn.dataset.package = pkg;
                buyBtn.dataset.price = price;
            }
        }
        
        function showPaymentModal() {
            const buyBtn = document.getElementById('buyBtn');
            const selectedPackage = buyBtn.dataset.package;
            const selectedPrice = buyBtn.dataset.price;
            
            if (!selectedPackage) {
                showToast('Vui l√≤ng ch·ªçn g√≥i d·ªãch v·ª•', 'error');
                return;
            }
            
            if (!currentUser) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ mua h√†ng');
                setTimeout(() => {
                    window.location.href = 'account.html';
                }, 1500);
                return;
            }
            
            if (currentUser.balance < parseInt(selectedPrice)) {
                showToast('S·ªë d∆∞ kh√¥ng ƒë·ªß. Vui l√≤ng n·∫°p th√™m!', 'error');
                closeModal('paymentModal');
                showTopupModal();
                return;
            }
            
            const modal = document.getElementById('paymentModal');
            const content = document.getElementById('paymentContent');
            
            const packageNames = {
                'day': '1 Ng√†y',
                'week': '1 Tu·∫ßn',
                'month': '1 Th√°ng',
                'season': '1 M√πa (3 th√°ng)',
                'year': '1 NƒÉm'
            };
            
            content.innerHTML = `
                <div class="text-center mb-4">
                    <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-2xl mx-auto mb-3">
                        <i class="fa-solid fa-wallet"></i>
                    </div>
                    <h3 class="text-base font-bold mb-1">X√°c nh·∫≠n thanh to√°n</h3>
                    <p class="text-xs text-gray-500">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën mua g√≥i d·ªãch v·ª• n√†y?</p>
                </div>
                
                <div class="bg-gray-50 rounded-xl p-3 mb-4">
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-gray-600">S·∫£n ph·∫©m:</span>
                        <span class="text-xs font-semibold">${currentProduct.name}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-gray-600">G√≥i d·ªãch v·ª•:</span>
                        <span class="text-xs font-semibold text-indigo-600">${packageNames[selectedPackage]}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-gray-600">S·ªë d∆∞ hi·ªán t·∫°i:</span>
                        <span class="text-xs font-bold text-indigo-600">${formatMoney(currentUser.balance)}</span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-gray-600">Gi√° thanh to√°n:</span>
                        <span class="text-xs font-bold text-red-600">-${formatMoney(selectedPrice)}</span>
                    </div>
                    <div class="flex justify-between pt-2 border-t border-gray-200">
                        <span class="text-xs font-semibold">S·ªë d∆∞ c√≤n l·∫°i:</span>
                        <span class="text-xs font-bold text-green-600">${formatMoney(currentUser.balance - parseInt(selectedPrice))}</span>
                    </div>
                </div>
                
                <div class="flex gap-2">
                    <button onclick="processPayment()" class="flex-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-2 px-3 rounded-xl text-xs font-semibold hover:shadow-lg transition-all">
                        <i class="fa-solid fa-check mr-1"></i>
                        X√°c nh·∫≠n
                    </button>
                    <button onclick="closeModal('paymentModal')" class="px-4 py-2 border border-gray-200 rounded-xl text-xs font-semibold hover:bg-gray-50">
                        H·ªßy
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }
        
        async function processPayment() {
            const buyBtn = document.getElementById('buyBtn');
            const selectedPackage = buyBtn.dataset.package;
            
            closeModal('paymentModal');
            
            const formData = new FormData();
            formData.append('action', 'buyProduct');
            formData.append('userId', currentUser.id);
            formData.append('productId', currentProduct.id);
            formData.append('package', selectedPackage);
            formData.append('quantity', 1);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    const keys = data.transaction?.keys || [];
                    showToast(`‚úÖ Mua h√†ng th√†nh c√¥ng! Key: ${keys.join(', ')}`, 'success');
                    
                    refreshUserData();
                    
                    if (data.transaction?.discount > 0 && currentUser.type !== 'Th√¢n thi·∫øt') {
                        showToast('üéâ Ch√∫c m·ª´ng! B·∫°n ƒë√£ ƒë∆∞·ª£c n√¢ng c·∫•p l√™n t√†i kho·∫£n Th√¢n thi·∫øt!', 'success');
                        refreshUserData();
                    }
                    
                    buyBtn.disabled = true;
                    document.querySelectorAll('.package-item').forEach(el => {
                        el.classList.remove('selected');
                    });
                } else {
                    showToast(data?.message || 'Mua h√†ng th·∫•t b·∫°i', 'error');
                }
            } catch (error) {
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        // ==================== TOPUP FUNCTIONS ====================
        function showTopupModal() {
            if (!currentUser) {
                showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ n·∫°p ti·ªÅn');
                window.location.href = 'account.html';
                return;
            }
            
            document.getElementById('topupModal').classList.add('active');
        }
        
        async function processTopup() {
            const amount = document.getElementById('topupAmount').value;
            const method = document.getElementById('topupMethod').value;
            
            if (!amount || amount < 10000) {
                showToast('S·ªë ti·ªÅn n·∫°p t·ªëi thi·ªÉu 10,000‚Ç´', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('action', 'topup');
            formData.append('userId', currentUser.id);
            formData.append('amount', amount);
            formData.append('method', method);
            
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: formData });
                const data = await res.json();
                
                if (data && data.success) {
                    showToast('N·∫°p ti·ªÅn th√†nh c√¥ng!', 'success');
                    refreshUserData();
                    closeModal('topupModal');
                    document.getElementById('topupAmount').value = '';
                } else {
                    showToast(data?.message || 'N·∫°p ti·ªÅn th·∫•t b·∫°i', 'error');
                }
            } catch (error) {
                showToast('C√≥ l·ªói x·∫£y ra', 'error');
            }
        }
        
        // ==================== UTILITY FUNCTIONS ====================
        function formatMoney(amount) {
            if (amount === undefined || amount === null) return '0‚Ç´';
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + (type === 'success' ? 'success' : type === 'error' ? 'error' : '');
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        function logout() {
            localStorage.removeItem('currentUser');
            currentUser = null;
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>